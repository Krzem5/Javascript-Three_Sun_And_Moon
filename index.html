<!DOCTYPE html>
<html>
	<body>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/three.js/100/three.min.js"></script>
		<script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>
		<script src="https://threejs.org/examples/js/ImprovedNoise.js"></script>
		<script type="text/javascript">
			var scene,cam,renderer,controls,ambient,all_objects=[],NOISE=new ImprovedNoise().noise,SEED=Math.random(),SIZE=10
			function init(){
				scene=new THREE.Scene()
				cam=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,0.1,100000)
				cam.position.set(0,2000,0)
				cam.enablePan=false
				cam.lookAt(new THREE.Vector3(0,0,0))
				renderer=new THREE.WebGLRenderer({antialias:true})
				renderer.setSize(window.innerWidth,window.innerHeight)
				scene.background=new THREE.Color().setHSL(1,1,1)
				document.body.appendChild(renderer.domElement)
				ambient=new THREE.AmbientLight(0xececec,1)
				scene.add(ambient)
				renderer.render(scene,cam)
				controls=new THREE.OrbitControls(cam,renderer.domElement)
				controls.target=new THREE.Vector3(0,0,0)
				window.addEventListener("resize",resize,false)
				window.addEventListener("keypress",onkeypress)
				requestAnimationFrame(render)
				generate()
			}
			function render(){
				for (var k of all_objects){
					k.update()
				}
				renderer.render(scene,cam)
				requestAnimationFrame(render)
			}
			function resize(){
				cam.aspect=window.innerWidth/window.innerHeight
				cam.updateProjectionMatrix()
				renderer.setSize(window.innerWidth,window.innerHeight)
			}
			function onkeypress(e){
				switch (e.keyCode){
					case 49: //Left Arrow
						find("sun_and_moon")[0].rotS=1
						break
					case 113: //Top Arrow
						find("sun_and_moon")[0].rotS=0
						break
					case 50: //Right Arrow
						find("sun_and_moon")[0].rotS=2
						break
					case 51: //Down Arrow
						find("sun_and_moon")[0].rotS=3
						break
				}
			}
			function generate(){
				all_objects.push(SunAndMoon())
				all_objects.push(Terrain())
			}
			function find(n){
				var a=[]
				for (var k of all_objects){
					if (k.type==n){a.push(k)}
				}
				return a
			}
			Number.prototype.map=function(as,ae,bs,be){
				return (this-as)*(be-bs)/(ae-as)+bs
			}
			Number.prototype.mapC=function(as,ae,c1,c2){
				return [this.map(as,ae,c1[0]/360,c2[0]/360),this.map(as,ae,c1[1]/100,c2[1]/100),this.map(as,ae,c1[2]/100,c2[2]/100)]
			}
			window.addEventListener("DOMContentLoaded",init,false)
		</script>
		<script type="text/javascript">
			function Terrain(){
				var g=new THREE.Group()
				g.rotation.x=Math.PI/2
				for (var y=0;y<SIZE;y++){
					for (var x=0;x<SIZE;x++){
						var c=Chunk(x-Math.floor(SIZE/2),y-Math.floor(SIZE/2))
						g.add(c.object)
						all_objects.push(c)
					}
				}
				scene.add(g)
				return {
					type: "terrain",
					chunkList: g,
					create_chunk: function(x,y){
						var c=Chunk(x,-y)
						this.chunkList.add(c.object)
						all_objects.push(c)
					},
					update: function(){
						//
					}
				}
			}
			function get_noise(x,y){return NOISE(x,y,SEED)*600}
			function Chunk(x,y){
				var mesh=new THREE.Mesh(new THREE.PlaneGeometry(1000,1000,10,10),new THREE.MeshStandardMaterial({color:0xa3f707,side:THREE.DoubleSide,flatShading:true,metalness:0.5,roughness:0.9}))
				mesh.reciveShadow=true
				mesh.castShadow=true
				mesh.position.set(x*1000,y*-1000,0)
				scene.add(mesh)
				for (var j=0;j<11;j++){
					for (var i=0;i<11;i++){
						mesh.geometry.vertices[j*11+i].z=get_noise(x+i/10,y+j/10)
					}
				}
				return {
					type: "chunk",
					object: mesh,
					v: true,
					update: function(){
						this.object.visible=this.v
					}
				}
			}
			function SunAndMoon(){
				var sun=new THREE.SpotLight(0xffffff,1,0,1)
				sun.position.set(200,200,200)
				sun.target.position.set(0,0,0)
				sun.castShadow=true
				sun.shadow.mapSize.width=1024
				sun.shadow.mapSize.height=1024
				sun.shadow.camera.near=0.5
				sun.shadow.camera.far=15000
				var g=new THREE.Mesh(new THREE.SphereGeometry(150,32,32,0,6.3,0,3.1),new THREE.MeshBasicMaterial({color:0xdddd00}))
				sun.add(g)
				var moon=new THREE.SpotLight(0xcecece,1,0,1)
				moon.position.set(200,200,200)
				moon.target.position.set(0,0,0)
				moon.castShadow=true
				moon.shadow.mapSize.width=1024
				moon.shadow.mapSize.height=1024
				moon.shadow.camera.near=0.5
				moon.shadow.camera.far=15000
				var g2=new THREE.Mesh(new THREE.SphereGeometry(70,32,32,0,6.3,0,3.1),new THREE.MeshBasicMaterial({color:0xbfbfbf}))
				moon.add(g2)
				var gr=new THREE.Group()
				gr.add(sun)
				gr.add(moon)
				scene.add(gr)
				scene.add(sun.target)
				scene.add(moon.target)
				return {
					type: "sun_and_moon",
					sun: sun,
					moon: moon,
					object: gr,
					pos: new THREE.Vector3(0,0,0),
					rotA: 45,
					rotS: 2,// 0-no rotation, 1-slow rotation, 2-normal rotation, 3-fast rotation
					update: function(){
						this.rotA+=[0,0.01,0.075,0.3][this.rotS]
						var a=17500,b=2000
						var ang=THREE.Math.degToRad(this.rotA)
						var p=this.pos.clone()
						this.sun.position.set(a*Math.cos(ang)+p.x,b*Math.sin(0.5*ang)+p.y,a*Math.sin(ang)+p.z)
						this.sun.intensity=Math.min(Math.max(3*Math.sin(0.5*ang),0),2)
						this.sun.children[0].material.color.setHSL(this.sun.intensity.map(0,2,30/360,60/360),1,0.5)
						this.sun.visible=this.sun.position.y>-1000
						this.moon.position.set(a*Math.cos(ang+Math.PI)+p.x,-b*Math.sin(0.5*ang)+p.y,a*Math.sin(ang+Math.PI)+p.z)
						this.moon.intensity=Math.max(0.75-this.sun.intensity,0)
						this.moon.visible=this.moon.position.y>-1000
						ambient.color.setHSL(230/360,1,this.sun.intensity.map(0,2,50/100,100/100))
						scene.background.setHSL(...this.sun.intensity.mapC(0,2,[235,100,2],[186,84,80]))
					}
				}
			}
		</script>
		<style type="text/css">
			body {margin:0;padding:0;overflow:hidden;}
			canvas {width:100%;height:100%}
		</style>
	</body>
</html>